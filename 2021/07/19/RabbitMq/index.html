<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="candy"><title>RabbitMq · Candy</title><meta name="description" content="rabbitmq集群配置搭建mq队列(http://88250.b3log.org/rabbitmq-clustering-ha)
一.安装EPEL库wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch."><meta name="keywords" content="Candy博客,Candy'sBlog,博客"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Candy</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/candyYu"><i class="fa fa-github"></i></a></li><li><a href="candyDocker@gmail.com"><i class="fa fa-envelope"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2021 </span><i class="fa fa-star"></i><span> candy</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>RabbitMq</a></h3></div><div class="post-content"><h2 id="rabbitmq集群配置搭建"><a href="#rabbitmq集群配置搭建" class="headerlink" title="rabbitmq集群配置搭建"></a>rabbitmq集群配置搭建</h2><p>mq队列(<a target="_blank" rel="noopener" href="http://88250.b3log.org/rabbitmq-clustering-ha">http://88250.b3log.org/rabbitmq-clustering-ha</a>)</p>
<h3 id="一-安装EPEL库"><a href="#一-安装EPEL库" class="headerlink" title="一.安装EPEL库"></a>一.安装EPEL库</h3><p>wget <a target="_blank" rel="noopener" href="http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm">http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a></p>
<p>rpm -ivh epel-release-6-8.noarch.rpm</p>
<h3 id="二-安装erlang"><a href="#二-安装erlang" class="headerlink" title="二.安装erlang"></a>二.安装erlang</h3><p>yum install erlang</p>
<p>强制安装erlang</p>
<p>rpm –force -i <a href="erlang-20.3-1.el6.x86_64.rpm">erlang-20.3-1.el6.x86_64.rpm</a> </p>
<h3 id="三-rabbitmq"><a href="#三-rabbitmq" class="headerlink" title="三.rabbitmq"></a>三.rabbitmq</h3><p>1.安装</p>
<p>wget <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/releases/rabbitmq-server/v3.5.0/rabbitmq-server-3.5.0-1.noarch.rpm">http://www.rabbitmq.com/releases/rabbitmq-server/v3.5.0/rabbitmq-server-3.5.0-1.noarch.rpm</a></p>
<p>rpm -ivh <a href="rabbitmq-server-3.5.0-1.noarch.rpm">rabbitmq-server-3.5.0-1.noarch.rpm</a></p>
<p>rpm -ivh –nodeps <a href="rabbitmq-server-3.7.6-1.el6.noarch.rpm">rabbitmq-server-3.7.6-1.el6.noarch.rpm</a></p>
<p>2.启动服务：service rabbitmq-server start</p>
<p> 启动维护插件：rabbitmq-plugins enable rabbitmq_management</p>
<p> 重启服务：service rabbitmq-server restart</p>
<p>3.添加用户：rabbitmqctl add_user test 123456</p>
<p>   修改密码：rabbitmqctl change_password Username 123456</p>
<p>4.添加管理员权限：rabbitmqctl set_user_tags test administrator</p>
<p>5.访问端口15672</p>
<p>6.设置账号权限：rabbitmqctl set_permissions -p “/“ test “.<em>“ “.</em>“ “.*” </p>
<p>3.添加用户：rabbitmqctl add_user huashu 123456</p>
<p>4.添加用户权限 rabbitmqctl set_permissions huashu “.<em>“ “.</em>“ “.*”</p>
<p>5.添加管理员权限：rabbitmqctl set_user_tags huashu administrator</p>
<h3 id="四-rabbitmq集群配置"><a href="#四-rabbitmq集群配置" class="headerlink" title="四.rabbitmq集群配置"></a>四.rabbitmq集群配置</h3><p>1.修改 /etc/hosts</p>
<p> 加入集群节点的描述：</p>
<p> ip1 app-server1</p>
<p>ip2  app-server2</p>
<p>2.设置erlang cookie</p>
<p> 文件路径：/var/lib/rabbitmq/.erlang.cookie</p>
<p> 将app-server1的文件值复制到app-server2中</p>
<p> 先修改app-server2中的文件权限 ＃chmod 777 /var/lib/rabbitmq/.erlang.cookie</p>
<p> 复制好后把文件权限改回去 ＃chmod 400 /var/lib/rabbitmq/.erlang.cookie</p>
<p>3.使用-detached参数运行各节点</p>
<p> # rabbitmqctl stop</p>
<p> # rabbitmq-server -detached</p>
<p>4.组成集群</p>
<p> 将app-server1和app-server2组成集群，将app-server2加入app-server1</p>
<p> app-server2# rabbitmqctl stop_app </p>
<p> app-server2# rabbitmqctl join_cluster rabbit@app-server1</p>
<p> app-server2# rabbitmqctl start_app</p>
<p> 查看集群配置是否成功：rabbitmqctl cluster_status</p>
<p>5.修改磁盘节点为内存节点</p>
<p>rabbitmqctl stop_app</p>
<p>rabbitmqctl change_cluster_node_type ram</p>
<p>rabbitmqctl start_app</p>
<p>6.设置镜像队列策略</p>
<p> 在任意一个节点上执行rabbitmqctl set_policy ha-all “^” ‘{“ha-mode”:”all”}’</p>
<p>​      rabbitmqctl set_policy -p / ha-allqueue “^” ‘{“ha-mode”:”all”}’</p>
<p>修改mq节点属性：rabbitmqctl change_cluster_node_type ram</p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/db0f5496f0d2">https://www.jianshu.com/p/db0f5496f0d2</a></p>
<h2 id="rabbitmq-防止消息丢失"><a href="#rabbitmq-防止消息丢失" class="headerlink" title="rabbitmq  防止消息丢失"></a>rabbitmq  防止消息丢失</h2><p>队列和消息定义都要持久化</p>
<p>Exchange持久化 、Queue持久化、 Message持久化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* mq助手，解决发送和接收问题</span><br><span class="line">* MQ事务问题</span><br><span class="line">*</span><br><span class="line">* 事务的实现主要是对信道（Channel）的设置</span><br><span class="line">* channel.txSelect()声明启动事务模式；</span><br><span class="line">* channel.txComment()提交事务；</span><br><span class="line">* channel.txRollback()回滚事务；</span><br><span class="line">*</span><br><span class="line">* Confirm发送方确认模式</span><br><span class="line">* Confirm普通模式</span><br><span class="line">* Confirm批量模式</span><br><span class="line">* Confirm异步监听方式</span><br><span class="line">* Confirm的三种实现方式：</span><br><span class="line">* // 开启发送方确认模式</span><br><span class="line">* channel.confirmSelect();</span><br><span class="line">* 方式一：channel.waitForConfirms()普通发送方确认模式；</span><br><span class="line">*</span><br><span class="line">* 方式二：channel.waitForConfirmsOrDie()批量确认模式；</span><br><span class="line">*</span><br><span class="line">* 方式三：channel.addConfirmListener()异步监听发送方确认模式</span><br></pre></td></tr></table></figure>



<p>死信队列</p>
<p>DLX 是一个普通的交换器，可以在任何队列上设置，当死信消息出现时，RabbitMQ 自动将这个 <strong>消息重新发布到设置的 DLX 上</strong>，从而被路由到另一个队列，即 <strong>死信队列</strong></p>
<p>在队列定义时，使用 <code>x-dead-letter-exchange</code> 参数来为这个队列添加 DLX</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line"><span class="comment">// 定义 dlx</span></span><br><span class="line">channel.exchangeDeclare(<span class="string">&quot;exchange.dlx&quot;</span>, <span class="string">&quot;direct&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// 定义 dlx queue</span></span><br><span class="line">channel.queueDeclare(<span class="string">&quot;queue.dlx&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">channel.queueBind(<span class="string">&quot;queue.dlx&quot;</span>, <span class="string">&quot;exchange.dlx&quot;</span>, <span class="string">&quot;dlx-routing-key&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义正常的交换器</span></span><br><span class="line">channel.exchangeDeclare(<span class="string">&quot;exchange.normal&quot;</span>, <span class="string">&quot;fanout&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">final</span> HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// 定义队列事，通过该属性给该队列设置 DLX</span></span><br><span class="line">arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;exchange.dlx&quot;</span>);</span><br><span class="line"><span class="comment">// 还可以通过该属性重新消息的路由键，否则使用原消息的路由键</span></span><br><span class="line">arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx-routing-key&quot;</span>);</span><br><span class="line"><span class="comment">// 设置该队列的 ttl</span></span><br><span class="line">arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;queue.normal&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, arguments);</span><br><span class="line">channel.queueBind(<span class="string">&quot;queue.normal&quot;</span>, <span class="string">&quot;exchange.normal&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>



</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-07-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Java/" title="Java">Java </a><a class="tag" href="/tags/MQ/" title="MQ">MQ </a><a class="tag" href="/tags/Java/" title="Java">Java </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2021/07/19/RabbitMq/,Candy,RabbitMq,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2021/12/03/Redis%E7%B3%BB%E5%88%97%E4%B8%80/" title="Redis系列一">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/07/12/%E7%9F%A5%E8%AF%86%E8%A1%A5%E5%85%85/" title="知识补充">下一篇</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>